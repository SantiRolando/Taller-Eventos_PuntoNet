@page "/login"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using Eventos_PuntoNet.Components.Models
@using Eventos_PuntoNet.Components.Services
@inject IDbContextFactory<Eventos_PuntoNet.Components.Data.AppDbContext> DbFactory
@inject SessionService Session
@inject NavigationManager NavigationManager
@using System.Text.Json

<PageTitle>Iniciar Sesión</PageTitle>

<section class="login-section">
    <div class="login-card">
        <h2>Iniciar Sesión</h2>

        <EditForm Model="@loginData">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="form-group">
                <label for="email">Correo electrónico</label>
                <InputText id="email"
                           @bind-Value="loginData.Email"
                           type="email"
                           class="form-control" />
            </div>

            <div class="form-group">
                <label for="password">Contraseña</label>
                <InputText id="password"
                           @bind-Value="loginData.Password"
                           type="password"
                           class="form-control" />
            </div>

            <button type="button"
                    class="btn-login-page"
                    @onclick="() => LoginUsuario()">
                Ingresar
            </button>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <p class="text-danger">@errorMessage</p>
            }

            <p class="register-link">
                ¿No tienes una cuenta?
                <NavLink href="/register">Regístrate aquí</NavLink>
            </p>
        </EditForm>
    </div>
</section>

@code {
    private LoginModel loginData { get; set; } = new();
    private string errorMessage = string.Empty;

    private async Task LoginUsuario()
    {
        Console.WriteLine($"Email: '{loginData.Email}', Password: '{loginData.Password}'");

        if (string.IsNullOrWhiteSpace(loginData.Email) || string.IsNullOrWhiteSpace(loginData.Password))
        {
            errorMessage = "Por favor, ingrese los datos.";
            return;
        }

        try
        {
            using var context = DbFactory.CreateDbContext();

            var usuario = await context.Usuarios
                .FirstOrDefaultAsync(u => u.Email == loginData.Email && u.Password == loginData.Password);

            if (usuario == null)
            {
                errorMessage = "Correo o contraseña incorrectos.";
                return;
            }

            await Session.GuardarUsuario(usuario);
            NavigationManager.NavigateTo("/", true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"LoginUsuario: {ex}");
            errorMessage = "Ocurrió un error al iniciar sesión. Intente nuevamente.";
        }
    }

    public class LoginModel
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}