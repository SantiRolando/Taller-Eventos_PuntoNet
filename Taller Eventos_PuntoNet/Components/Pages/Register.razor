@page "/register"
@using Microsoft.EntityFrameworkCore
@using Eventos_PuntoNet.Components.Models
@using Microsoft.AspNetCore.Components.Forms
@inject IDbContextFactory<Eventos_PuntoNet.Components.Data.AppDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Crear cuenta</PageTitle>

<section class="register-section">
    <div class="register-card">
        <h2>Crear cuenta</h2>
        <EditForm EditContext="editContext" OnValidSubmit="AddUsuario" FormName="registerForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="form-group">
                <label for="cedula">Cédula</label>
                <InputText id="cedula" @bind-Value="usuario.Ci" placeholder="Ej. 1.234.567-8" class="form-control" />
                <ValidationMessage For="@(() => usuario.Ci)" />
            </div>

            <div class="form-group">
                <label for="nombre">Nombre</label>
                <InputText id="nombre" @bind-Value="usuario.Nombre" placeholder="Tu nombre completo" class="form-control" />
                <ValidationMessage For="@(() => usuario.Nombre)" />
            </div>

            <div class="form-group">
                <label for="email">Correo electrónico</label>
                <InputText id="email" type="email" @bind-Value="usuario.Email" placeholder="nombre@dominio.com" class="form-control" />
                <ValidationMessage For="@(() => usuario.Email)" />
            </div>

            <div class="form-group">
                <label for="password">Contraseña</label>
                <InputText id="password" type="password" @bind-Value="usuario.Password" placeholder="Mínimo 6 caracteres" class="form-control" />
                <ValidationMessage For="@(() => usuario.Password)" />
            </div>

            <div class="form-group">
                <label for="tipo">Tipo de usuario</label>
                <InputSelect id="tipo" @bind-Value="usuario.TipoUsuario" TValue="string" class="form-control">
                    <option value="Participante">Participante</option>
                    <option value="Administrador">Administrador</option>
                </InputSelect>
                <ValidationMessage For="@(() => usuario.TipoUsuario)" />
            </div>

            <button type="submit" class="btn-register" disabled="@isSubmitting">Registrarse</button>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <p class="text-danger">@errorMessage</p>
            }

            <p class="login-link">
                ¿Ya tienes una cuenta?
                <NavLink href="/login">Inicia sesión aquí</NavLink>
            </p>
        </EditForm>
    </div>
</section>

@code {
    private Usuario usuario = new() { TipoUsuario = "Participante" };
    private EditContext editContext;
    private string errorMessage = string.Empty;
    private bool isSubmitting = false;

    protected override void OnInitialized()
    {
        editContext = new EditContext(usuario);
    }

    private async Task AddUsuario()
    {

        Console.WriteLine("entre al add");

        if (isSubmitting) return;

        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            using var context = DbFactory.CreateDbContext();

            // Normalizar valores
            var ciNormalized = usuario.Ci?.Trim();
            var emailNormalized = usuario.Email?.Trim().ToLowerInvariant();

            bool existe = await context.Usuarios
                .AsNoTracking()
                .AnyAsync(u => u.Ci == ciNormalized || u.Email.ToLower() == emailNormalized);

            Console.WriteLine("existe usuario =" + existe);
            if (existe)
            {
                errorMessage = "Ya existe un usuario registrado con esa cédula o correo electrónico.";
                return;
            }

            Console.WriteLine("datos usuario" + usuario.Ci);

            Usuario entidad = usuario.TipoUsuario == "Administrador"
                ? new Admin
                {
                    Ci = ciNormalized,
                    Nombre = usuario.Nombre?.Trim(),
                    Email = emailNormalized,
                    Password = usuario.Password,
                    TipoUsuario = usuario.TipoUsuario
                }
                : new Participante
                {
                    Ci = ciNormalized,
                    Nombre = usuario.Nombre?.Trim(),
                    Email = emailNormalized,
                    Password = usuario.Password,
                    TipoUsuario = usuario.TipoUsuario
                };

            context.Usuarios.Add(entidad);
            await context.SaveChangesAsync();

            

            Console.WriteLine("AddUsuario: guardado correctamente. Navegando a / ...");

            NavigationManager.NavigateTo("/", true);
        }
        catch (DbUpdateException ex)
        {
            errorMessage = "Error al guardar el usuario. Puede que ya exista o haya un problema con la base de datos.";
            Console.Error.WriteLine(ex);
        }
        catch (Exception ex)
        {
            errorMessage = "Ocurrió un error inesperado.";
            Console.Error.WriteLine(ex);
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
