@page "/admin/GestorCarrera"
@using Eventos_PuntoNet.Components.Models
@using Eventos_PuntoNet.Components.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Navigation

@rendermode InteractiveServer

<link href="css/site.css" rel="stylesheet" />

<PageTitle>GestiÃ³n de Carreras</PageTitle>

<div class="gestor-carreras">

    <section class="contenido">

        <div class="header">
            <h1>GestiÃ³n de Carreras</h1>
            <a href="/admin/crear-evento" class="btn-crear">â• Crear Evento</a>
        </div>

        
        <div class="busqueda">
            <input type="text" placeholder="Buscar evento..." @bind="searchTerm" @bind:event="oninput" />
        </div>

        <br />
        <br />

       
        <div class="lista-carreras">
            @foreach (var evento in eventosPaginados)
            {
                <div class="carrera-card">

                   
                    @if (evento.Imagen != null)
                    {
                        <img src="data:image/png;base64,@Convert.ToBase64String(evento.Imagen)" />
                    }
                    else
                    {
                        <img src="/img/no-image.png" />
                    }

                    <div class="carrera-info">
                        <h3>@evento.Nombre</h3>

                        <p><b>ğŸ“ Distancia:</b> @evento.Km km</p>
                        <p><b>ğŸ“¦ Kits:</b> @evento.Cantidad_Kits</p>
                        <p><b>ğŸ“¡ Sensores:</b> @evento.Sensores?.Count</p>

                        @if (evento.EnVivo)
                        {
                            <p><b>ğŸ Estado:</b> <span style="color: #28a745; font-weight: bold;">En vivo</span></p>
                        }
                        else if (evento.Leaderboard != null && evento.Leaderboard.Any())
                        {
                            <p><b>ğŸ Estado:</b> <span style="color: #dc3545; font-weight: bold;">Terminado</span></p>
                        }
                        else
                        {
                            <p><b>ğŸ Estado:</b> <span style="color: #f0ad4e; font-weight: bold;">No empezÃ³</span></p>
                        }


                        <div class="acciones">
                            <button class="btn-opciones" @onclick="() => EditarEvento(evento.Id)">âœï¸ Editar</button>
                            <button class="btn-eliminar" @onclick="() => ConfirmarEliminar(evento.Id)">ğŸ—‘ï¸ Eliminar</button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <br />
        <br />

        <div class="paginacion">
            <button @onclick="PrevPage" disabled="@(paginaActual == 1)">Anterior</button>
            <span>PÃ¡gina @paginaActual de @totalPaginas</span>
            <button @onclick="NextPage" disabled="@(paginaActual == totalPaginas)">Siguiente</button>
        </div>

        @if (mostrarConfirmacion)
        {
            <div class="popup-overlay">
                <div class="popup-box">

                    <h3>âš ï¸ Confirmar eliminaciÃ³n</h3>
                    <p>Â¿Seguro que deseas eliminar esta carrera?<br />Esta acciÃ³n es irreversible.</p>

                    <div class="popup-buttons">
                        <button class="btn-confirmar" @onclick="() => EliminarEvento(eventoAEliminarId)">Eliminar</button>
                        <button class="btn-cancelar" @onclick="() => mostrarConfirmacion = false">Cancelar</button>
                    </div>

                </div>
            </div>
        }



    </section>
</div>



@code {

    private bool mostrarConfirmacion = false;
    private int eventoAEliminarId = 0;

   
    
    private string searchTerm = "";

    private int paginaActual = 1;
    private int porPagina = 5;
    private int totalPaginas = 1;

    private List<Evento> eventos = new();
    private IEnumerable<Evento> eventosFiltrados =>
        string.IsNullOrWhiteSpace(searchTerm)
        ? eventos
        : eventos.Where(e => e.Nombre.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<Evento> eventosPaginados =>
        eventosFiltrados
        .Skip((paginaActual - 1) * porPagina)
        .Take(porPagina);

    protected override async Task OnInitializedAsync()
    {
        using var ctx = DbFactory.CreateDbContext();

        eventos = await ctx.Eventos
            .Include(e => e.Sensores)
            .ToListAsync();

        calcularPaginas();
    }

    private void calcularPaginas()
    {
        totalPaginas = (int)Math.Ceiling(eventosFiltrados.Count() / (double)porPagina);
        if (paginaActual > totalPaginas) paginaActual = totalPaginas;
        if (paginaActual < 1) paginaActual = 1;
    }

    private void PrevPage()
    {
        if (paginaActual > 1)
        {
            paginaActual--;
        }
    }

    private void NextPage()
    {
        if (paginaActual < totalPaginas)
        {
            paginaActual++;
        }
    }

    private void EditarEvento(int id)
    {
        Navigation.NavigateTo($"/admin/editar-evento/{id}");
    }

    private async Task EliminarEvento(int id)
    {
        using var ctx = DbFactory.CreateDbContext();
        var ev = await ctx.Eventos.Include(e => e.Sensores).FirstOrDefaultAsync(e => e.Id == id);

        if (ev != null)
        {
            ctx.Eventos.Remove(ev);
            await ctx.SaveChangesAsync();
        }

        // recargar lista
        eventos = await ctx.Eventos.Include(e => e.Sensores).ToListAsync();
        calcularPaginas();

        
        mostrarConfirmacion = false;

        StateHasChanged();
    }


    private void ConfirmarEliminar(int id)
    {
        eventoAEliminarId = id;
        mostrarConfirmacion = true;
    }
}
