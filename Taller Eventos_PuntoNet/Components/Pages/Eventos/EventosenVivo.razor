@page "/EventoenVivo"
@using Eventos_PuntoNet.Components.Data
@using Eventos_PuntoNet.Components.Models
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AppDbContext> DbFactory

<PageTitle>SEM | Eventos en Vivo</PageTitle>

<div class="main-eventos">
    <div class="tabs">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="proximos-eventos-tab" data-bs-toggle="tab" data-bs-target="#proximos-eventos-tab-pane" type="button" role="tab" aria-controls="proximos-eventos-tab-pane" aria-selected="true">
                    Evento en Vivo
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Próximos eventos -->
            <div class="tab-pane fade show active" id="proximos-eventos-tab-pane" role="tabpanel" aria-labelledby="proximos-eventos-tab" tabindex="0">
                <div class="imagenes-eventos">
                    <div class="row row-cols-1 row-cols-md-2 g-4">

                        @if (eventos == null || eventos.Count == 0)
                        {
                            <div class="col-12 text-center mt-5">
                                <h3 class="text-secondary">
                                    🚨 No hay eventos en vivo actualmente.
                                </h3>
                                <p>Vuelve más tarde para ver las últimas competencias.</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var evento in eventos)
                        {
                            var url = $"https://localhost:7046/Evento/EnVivo?Id={evento.Id}" +
                            $"&Titulo={Uri.EscapeDataString(evento.Titulo)}" +
                            $"&Descripcion={Uri.EscapeDataString(evento.Descripcion)}" +
                            $"&Fecha={Uri.EscapeDataString(evento.Fecha.ToString("yyyy-MM-dd HH:mm:ss"))}";

                            <div class="col">
                                <a class="card evento-card" href="@url" style="text-decoration:none; color:inherit;">
                                    <img src="@(!string.IsNullOrEmpty(evento.ImagenBase64)
                                                 ? evento.ImagenBase64
                                                 : "/imgs/no-image.png")"
                                     style="width:200px" />
                                    <div class="card-img-overlay">
                                        <h5 class="card-title">@evento.Titulo</h5>
                                        <p class="card-text">@evento.Descripcion</p>
                                        <p class="card-text"><small>@evento.Fecha</small></p>
                                    </div>
                                </a>
                            </div>
                        }
                        }
                    </div>
                </div>
            </div>

            <!-- Eventos terminados -->
            <div class="tab-pane fade" id="eventos-terminados-tab-pane" role="tabpanel" aria-labelledby="eventos-terminados-tab" tabindex="0">
                <!-- Contenido adicional -->
            </div>
        </div>
    </div>
</div>

@code {
    record Evento(int Id, string Titulo, string Descripcion, string Fecha, string ImagenUrl);

    // La lista se inicializa como nula.
    private List<EventoAux>? eventos;

    // ⭐ Record Auxiliar: SOLO incluye Id, Titulo, e ImagenUrl
    public record EventoAux(int Id, string Titulo, string? ImagenBase64, string Descripcion, DateTime Fecha);



    protected override async Task OnInitializedAsync()
    {
        // 1. Crea el contexto de DB
        using var context = DbFactory.CreateDbContext();


        var debug = await context.Eventos
            .Where(e => e.Activo && e.EnVivo)
            .ToListAsync();

        Console.WriteLine($"Cantidad eventos en vivo: {debug.Count}");
        foreach (var e in debug)
        {
            Console.WriteLine($"{e.Id} - {e.Nombre} - Imagen: {(e.Imagen != null ? "SI" : "NO")}");
        }

        // 2. Consulta a la DB, mapeando solo las columnas disponibles.
        eventos = await context.Eventos
             .Where(e => e.Activo && e.EnVivo)
            .Select(e => new EventoAux(
            e.Id,
            e.Nombre,
            e.Imagen != null ? $"data:image/jpeg;base64,{Convert.ToBase64String(e.Imagen)}" : null,
            e.Descripcion ?? "",
            e.Fecha
            ))
             .ToListAsync();

        StateHasChanged();

    }
}
