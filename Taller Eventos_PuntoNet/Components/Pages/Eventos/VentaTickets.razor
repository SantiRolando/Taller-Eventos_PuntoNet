@page "/eventos/{Id:int}/comprar"

@using Eventos_PuntoNet.Components.Data
@using Eventos_PuntoNet.Components.Models
@using Microsoft.EntityFrameworkCore

@inject IDbContextFactory<AppDbContext> DbFactory

<PageTitle>SEM | Tickets</PageTitle>

<div class="compra-evento">

    @if (eventoSeleccionado is not null)
    {

        <div class="card mb-3 evento-card-ticket">
            <div class="row g-0">

                <img src="@(eventoSeleccionado.Imagen != null
                                                  ? $"data:image/jpeg;base64,{Convert.ToBase64String(eventoSeleccionado.Imagen)}"
                                                  : "/img/no-image.png")"
                 class="img-fluid rounded-start"
                 alt="@eventoSeleccionado.Nombre" />

                <div class="col-md-6">

                    <div class="card-body informacion-evento">

                        <h4 class="card-title">@eventoSeleccionado.Nombre</h4>

                        <p class="card-text texto-rojo">@eventoSeleccionado.Ubicacion</p>

                        <p class="card-text">@eventoSeleccionado.Descripcion</p>

                        <!-- Estado del evento -->
                    @if (eventoSeleccionado.EnVivo)
                        {
                            <p>
                                <b>🏁 Estado:</b>
                                <span style="color: #28a745; font-weight: bold;">En vivo</span>
                            </p>
                        }
                        else if (eventoSeleccionado.Leaderboard != null && eventoSeleccionado.Leaderboard.Any())
                        {
                            <p>
                                <b>🏁 Estado:</b>
                                <span style="color: #dc3545; font-weight: bold;">Terminado</span>
                            </p>
                        }
                        else
                        {
                            <p>
                                <b>🏁 Estado:</b>
                                <span style="color: #f0ad4e; font-weight: bold;">No empezó</span>
                            </p>
                        }

                        <div class="evento-detalles">
                            <div>
                                <i class="bi bi-geo-alt"></i>
                                <p class="card-text"><small>@eventoSeleccionado.Ubicacion</small></p>
                            </div>

                            <div>
                                <i class="bi bi-calendar4-event"></i>
                                <p class="card-text"><small>@eventoSeleccionado.Fecha</small></p>
                            </div>

                            <div>
                                <i class="bi bi-compass"></i>
                                <p class="card-text"><small>@eventoSeleccionado.Km</small></p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    }

</div>

<!-- SECCIÓN DE TICKETS / EN VIVO / TERMINADO -->
<div class="seccion-tickets-evento">
    @if (eventoSeleccionado is not null)
    {
        <!-- Evento en vivo -->
        if (eventoSeleccionado.EnVivo)
        {
            <div class="text-center mt-4">
                <a class="btn btn-danger btn-lg" href="/eventos/@eventoSeleccionado.Id/en-vivo">
                    🔴 Ver Evento en Vivo
                </a>
            </div>
        }
        <!-- Evento terminado -->
        else if (eventoSeleccionado.Leaderboard != null && eventoSeleccionado.Leaderboard.Any())
        {
            <div class="text-center mt-4">
                <h3 class="text-muted">Este evento ya finalizó</h3>
                <a class="btn btn-outline-light mt-3" href="/eventos/@eventoSeleccionado.Id/leaderboard">
                    📊 Ver Resultados
                </a>
            </div>
        }
        <!-- Evento disponible para comprar -->
        else
        {
            <div class="row justify-content-center g-4">
                <h3>Comprar Tickets para @eventoSeleccionado.Nombre</h3>

                <div class="col-md-4">
                    <div class="card card-ticket anticipadas">
                        <div class="card-body">
                            <h5 class="card-title">Anticipadas</h5>
                            <p class="card-precio">$2.500</p>
                            <button class="btn btn-comprar" @onclick="ComprarAnticipada">Comprar</button>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card card-ticket">
                        <div class="card-body">
                            <h5 class="card-title">Generales</h5>
                            <p class="card-precio">$3.200</p>
                            <button class="btn btn-comprar" @onclick="ComprarGeneral">Comprar</button>
                        </div>
                    </div>
                </div>

            </div>
        }
    }
</div>

@code {

    [Parameter] public int Id { get; set; }

    private Evento? eventoSeleccionado;

    protected override async Task OnParametersSetAsync()
    {
        using var ctx = DbFactory.CreateDbContext();

        eventoSeleccionado = await ctx.Eventos
            .Include(e => e.Leaderboard)
            .FirstOrDefaultAsync(e => e.Id == Id);
    }

    void ComprarAnticipada()
    {
        Console.WriteLine("Compra anticipada para evento " + eventoSeleccionado?.Nombre);
    }

    void ComprarGeneral()
    {
        Console.WriteLine("Compra general para evento " + eventoSeleccionado?.Nombre);
    }
}
