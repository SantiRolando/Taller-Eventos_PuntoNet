@page "/eventos"
@using Eventos_PuntoNet.Components.Models
@using Eventos_PuntoNet.Components.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager NavManager

<PageTitle>SEM | Eventos</PageTitle>

<div class="main-eventos">
    <div class="tabs">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="proximos-eventos-tab" data-bs-toggle="tab" data-bs-target="#proximos-eventos-tab-pane" type="button">Próximos Eventos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="eventos-terminados-tab" data-bs-toggle="tab" data-bs-target="#eventos-terminados-tab-pane" type="button">Eventos Terminados</button>
            </li>
        </ul>

        <div class="tab-content">

            @* ---------- PROXIMOS EVENTOS ---------- *@
            <div class="tab-pane fade show active" id="proximos-eventos-tab-pane">
                <div class="row row-cols-1 row-cols-md-2 g-4">
                    @foreach (var evento in proximos)
                    {
                        <div class="col">
                            <a class="card evento-card" href="@($"/eventos/{evento.Id}/comprar")">

                                <img src="@(evento.Imagen != null ? $"data:image/jpeg;base64,{Convert.ToBase64String(evento.Imagen)}" : "/img/no-image.png")"
                                     class="card-img" />

                                <div class="card-img-overlay">
                                    <h5 class="card-title">@evento.Nombre</h5>
                                    <p class="card-text">@evento.Descripcion</p>
                                    <p class="card-text">
                                        <small>@evento.Fecha.ToString("dd/MM/yyyy") - @evento.Ubicacion</small>
                                    </p>

                                    @if (evento.EnVivo)
                                    {
                                        <p><b>🏁 Estado:</b> <span style="color: #28a745; font-weight: bold;">En vivo</span></p>
                                    }
                                    else if (evento.Leaderboard != null && evento.Leaderboard.Any())
                                    {
                                        <p><b>🏁 Estado:</b> <span style="color: #dc3545; font-weight: bold;">Terminado</span></p>
                                    }
                                    else
                                    {
                                        <p><b>🏁 Estado:</b> <span style="color: #f0ad4e; font-weight: bold;">No empezó</span></p>
                                    }

                                </div>
                            </a>
                        </div>
                    }
                </div>
            </div>


            @* ---------- EVENTOS TERMINADOS ---------- *@
            <div class="tab-pane fade" id="eventos-terminados-tab-pane">

                @if (terminados.Count == 0)
                {
                    <p class="text-center mt-4">No hay eventos terminados aún.</p>
                }
                else
                {
                    <div class="row row-cols-1 row-cols-md-2 g-4">
                        @foreach (var evento in terminados)
                        {
                            <div class="col">
                                <div class="card">
                                    <img src="@(evento.Imagen != null ? $"data:image/jpeg;base64,{Convert.ToBase64String(evento.Imagen)}" : "/img/no-image.png")"
                                         class="card-img-top" />

                                    <div class="card-body">
                                        <h5>@evento.Nombre</h5>
                                        <p>@evento.Descripcion</p>
                                        <button class="btn btn-dark" @onclick="() => VerLeaderboard(evento.Id)">Ver Resultados</button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

        </div>
    </div>
</div>

@code {
    List<Evento> proximos = new();
    List<Evento> terminados = new();

    protected override async Task OnInitializedAsync()
    {
        using var ctx = DbFactory.CreateDbContext();

        var eventos = await ctx.Eventos
            .Include(e => e.Leaderboard)
            .ToListAsync();

        proximos = eventos
            .Where(e => (e.Leaderboard == null || !e.Leaderboard.Any()))
            .ToList();

        terminados = eventos
            .Where(e => !e.EnVivo && e.Leaderboard != null && e.Leaderboard.Any())
            .ToList();
    }

    void VerLeaderboard(int idEvento)
    {
        NavManager.NavigateTo($"/eventos/{idEvento}/leaderboard");
    }
}
